# 認証機構と役割

## 機能グループと役割の定義

### 機能グループの定義
今回のWBでは、以下の通り機能を大きく３グループに分類することができる。
1. 店舗業務に関する機能
2. 従業員個人に関する機能
3. 本部業務に関する機能

それぞれの機能グループに応じて、サイトを別にすべきと考える。

ex.
1. shop.yamaokaya.winboard.jp
2. personal.yamaokaya.winboard.jp
3. hq.yamaokaya.winboard.jp

> ユーザーに対するfacadeは分割するが、当然バックエンドは一つのものを共有する。RESTサービスのドメインも共有で良いと思われる。


##### 理由:
* 1,2はインターネットからアクセスさせたいが、3はさせたくない。
* 従業員個人に関する機能の想定端末はスマートフォンであるが、スマートフォンを保持しない従業員への救いの手として、店舗PCでの運用も想定しておく必要がある。この時、店舗管理と個人管理を同一システムとして運用すると、プライバシー面での事故を誘発する可能性があるため。
* 店舗画面を見ながら本部画面で処理したい、という本部側のニーズに対応するため。

### 役割の定義
ロールは、サイト別に定義されるべきである。
以下にYにおいて想定される、サイトごとのロール定義を示す。

---

#### 店舗業務サイト

##### スタッフロール
店舗のPCを使えるスタッフに無条件に与えられる役割
* 自店の勤怠 打刻
* 自店の勤怠(人件費省略版) 閲覧
* 自店の売上 入力（一部）
* 自店の小口現金 閲覧
* 自店の入金 閲覧
* 自店の日報 閲覧
* 本部通達 閲覧
* 他店日報 閲覧
* ELISへの遷移
* 金銭チェック 入力

##### マネージャーロール(店長)
任意の店舗へマネージャー権限を与えられたアカウントに付与される役割。
自店のスタッフロールと同等の役割を持つ他、以下の役割を持つ
* 自店の勤怠(完全版) 閲覧
* シフトの編集/確定
* 売上予算 編集
* 自店の勤怠申請 決裁
* 自店の勤怠申請 申請
* シフトパターン 編集
* 店舗横断ツール 使用
  * 申請消し込み

> 複数店舗のマネージャーを兼任している場合は、管理対象店舗を切り替えることが可能

##### シニアマネージャーロール(SV)
任意の店舗へシニアマネージャー権限を与えられたアカウントに付与される役割。
以下の役割を持つ
* 自店の勤怠(完全版) 閲覧
* 自店のシフト 編集/確定
* 自店のHLG 編集
* 店舗横断ツール 使用
  * 申請消し込み
  * マネージャー 任命/解任

> 複数店舗のシニアマネージャーを兼任している場合は、管理対象店舗を切り替えることが可能

##### 本部ロール
本部のスタッフに与えられる役割。
すべての機能について、閲覧が可能

##### 管理者ロール
システム管理者に付与されるべき役割。すべての機能についてあらゆる操作が可能。

---
#### 従業員サイト
個人向けの諸機能を提供するサイト。今回新設。
##### 個人ロール
スタッフ個人としての役割。提供される機能は、自分自身の管理に属することのみ。
* 自分の希望シフト 編集
* 自分のシフト 閲覧・プッシュ通知
* 自分の勤怠申請 申請
* 自分の顔写真 撮影
* 自分の個人情報 登録
* 自分の給与明細 閲覧
* 自分の源泉徴収票 閲覧

##### 退職者ロール
* 自分の給与明細 閲覧
* 自分の源泉徴収票 閲覧

##### 管理者ロール
システム管理者に付与されるべき役割。全従業員に対してあらゆる操作が可能。

---
#### 本部サイト
現在の本部タブに属する諸機能を提供するサイト。
さらに、分析系の諸機能とミッションクリティカルな機能に分類される。
分析系諸機能のすべてが見えていないため、ここではミッションクリティカルな機能にのみ言及する。

##### 会計ロール
* 売上の確定->会計システムへの連携
* 入金実績の登録

##### 勤怠ロール
* 給与明細データのアップロード
* 勤怠データの締め、給与システムへの連携

##### 管理者ロール
システム管理者に付与されるべき役割。すべての機能についてあらゆる操作が可能。


> 一般論ではあるが、役割管理は流動的に運用できる形（=ハードコーディングしない）設計であることが重要である。

---
## 認証機構について

サイト毎に方針が異なる。
#### 店舗業務サイト

前提:
イントラ内にIPクライアントのアドレスから店舗を特定するRESTサービスを用意しておく。

1. まず、IPアドレス認証を行い、店舗を特定できれば、スタッフロールにてサイトを表示する。
  * -> 一般スタッフが店舗業務サイトを使う場合の挙動
2. 店舗を特定できない場合は、ID/PASSによる通常の認証を実施・認証されたアカウントのロールにてサイトを表示する。
  * -> マネージャーが自宅から店舗管理のためにログインしたときの挙動
3. スタッフロールでサイトを表示したあと、「昇格」ボタンを押し、認証に成功すると、認証されたアカウントのロールにてサイトを表示する。
  * -> マネージャーが店舗のPCで店舗管理を行おうとしたときの挙動

#### 従業員サイト
* ID/PASSによる認証
* FB/google/twitter/yahoo/line等の外部認証機関経由でのログインを実現したいが、工数次第

##### 本部サイト
* ID/PASSによる認証
