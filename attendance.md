# 勤怠管理
***
### 一般ユーザー向け機能
#### 機能一覧
すべての従業員向けに以下の機能を公開する。

1. 個人を認証する[^2]
    * oauth2による認証
    * ID/PASSによる認証
    * 従業員アカウント数は、課金対象としないこと
1. 顔写真登録
    * 認証用および名札用
    * 認証の精度向上のために複数枚撮影して、本人が名札用写真をチョイスする機能を持つ
1. 希望シフトの登録
    * 登録方式をユーザーが選択できる
      * ホワイトリスト/ブラックリスト
1. 確定シフトの通知
    * 店長のシフト確定をトリガーにして従業員に確定結果をリリース
1. シフト開始直前のプッシュ通知
    * 確定済みシフト開始のn分前に本人に通知(SMSやメールで)。従業員ごとにパラメータを設定可能
1. 入力済み勤怠の修正申請
    * 本人申請による変更の入力フォームの用意。
    * だれがいつどこで変更・承認したかのトレーサビリティの確保
    * 理由
    * 変更履歴を、変更前に復元可能なレベルで保存。
1. 支払い済み給与明細の表示
    * PRからデータを受け取って表示するのみの機能
    * 人件費管理にも使用
    * 退職者も閲覧可能
1. 源泉徴収票のダウンロード
    * 年度を選択してのPDFのダウンロード機能のみ[^1]
    * 退職者も閲覧可能
1. 年間支払額予想の表示
    * 配偶者控除対象の主婦向けに
    * 1-12末までの確定合計と予想
1. 金銭実査

#### 対象クライアント
* PC用モダンプラウザ
* chrome on android
* safari,chrome on iOS

[^1]: PDFのアップロードは本部スタッフによる手動。
[^2]: メインWINBOARDと同じPCで運用する可能性があるため、別のサブドメインで運用する

### 店舗向け機能
#### 画面一覧
1. DWS
    * 希望シフト・実シフト・実績を並べて表示
    * 印刷
2. MWS
3. シフトパターン管理

#### 機能一覧
1. シフトを追加することができる
2. シフトを変更することができる
2. 希望シフトと実シフトのコンフリクトをチェックできる
3. 実シフトとDWSから導かれた必要人数のコンフリクトをチェックできる
4. 期間と対象人員を指定してシフトをフリーズすることができる
5. フリーズしたシフトを対象本人に通知することができる
6. フリーズしたシフトのフリーズを解除することができる
7. 現在日時からn日後の間にフリーズしていないシフトがあった場合、マネージャーにアラートすることができる
8. 現在日時からn日後の間に必要人数を満たさない日があった場合、マネージャーにアラートすることができる

##### 実績のデータ構造について
打刻の実績および修正履歴だけを記録しておき、そのデータからリアルタイムに実績を構築する。
[参考：この考え方を採用](https://www.byebye-timecard.net/blog/2006/11/bt.html)
###### データ構造案
* 各打刻データにIDを持ち、バージョン管理を行う
(ID+バージョンによるPK)
* 出勤と休憩OUTを同一視する = IN
* 退勤と休憩INを同一視する = OUT
* 確定FLGをレコードごとに持つ。打刻の場合はOUT時点で確定される

1.勤務中のデータ状況

OUTが打刻されるまでは、未確定の状態で進行。

打刻ID | 社員 | 組織 | 打刻 | 種別 | ver. | 確定FLG | 更新者 | 更新日時
--- | --- | --- | --- | --- | --- | --- | --- | ---
A | 013230 | 1111 | 8:59 | IN | 0 | false | 013230 | 8:59

OUT打刻時点で、前のINとthis OUTを確定する。

打刻ID | 社員 | 組織 | 打刻 | 種別 | ver. | 確定FLG | 更新者 | 更新日時
--- | --- | --- | --- | --- | --- | --- | --- | ---
A | 013230 | 1111 | 8:59 | IN | 0 | true | 013230 | 8:59
B | 013230 | 1111 | 11:30 | OUT | 0 | true | 013230 | 11:30

次にINが押されたら、そのINからはまた未確定。

打刻ID | 社員 | 組織 | 打刻 | 種別 | ver. | 確定FLG | 更新者 | 更新日時
--- | --- | --- | --- | --- | --- | --- | --- | ---
A | 013230 | 1111 | 8:59 | IN | 0 | true | 013230 | 8:59
B | 013230 | 1111 | 11:30 | OUT | 0 | true | 013230 | 11:30
C | 013230 | 1111 | 11:45 | IN | 0 | false | 013230 | 11:45

2.勤務終了の瞬間

このテーブルでは、休憩と出退勤の区別をしないので、一回の勤務データとしては、これで完成。

打刻ID | 社員 | 組織 | 打刻 | 種別 | ver. | 確定FLG | 更新者 | 更新日時
--- | --- | --- | --- | --- | --- | --- | --- | ---
A | 013230 | 1111 | 8:59 | IN | 0 | true | 013230 | 8:59
B | 013230 | 1111 | 11:30 | OUT | 0 | true | 013230 | 11:30
C | 013230 | 1111 | 11:45 | IN | 0 | true | 013230 | 11:45
D | 013230 | 1111 | 16:00 | OUT | 0 | true | 013230 | 16:00

ユーザーに対しては、
* OUT →　IN の インターバルが n時間[^1]以上の場合は、別の勤務として表示
* n時間未満の場合は、休憩と認識して

以下のように、ユーザフレンドリーに翻訳して表示する。

田中さん x日 8:59-16:00の勤務実績

時刻 | 種別 | 修正
--- | --- | ---
8:59 | 出勤 | [修正](#)
11:30 | 休憩開始 | [修正](#)
11:45 | 休憩終了 | [修正](#)
16:00 | 出勤 | [修正](#)

> SQL(window関数駆使)だけでなんとかできればベスト。

[^1]: インターバル時間数はグローバル設定にて定義

###### メリット
* １日２回以上の出勤と複数回休憩は、その概念の境界が曖昧であるため、熟練者による目視による判断が求められるが、このデータ構造により、判断を自動化できるのではないかと考えられる。
* 打刻時の動作の軽量化
* 複数回休憩実装の用意化
* データメンテナンスの容易性の向上
###### デメリット
* 計算能力を多く消費する。
* レコード数の増大
* UI上の表現が難しい(出勤IN=休憩OUTなど)

###ニーズ
* 紙の証跡を残す必要のない運用を構築すること

### メモ
* 勤務と勤務の間は11H開ける
* 開いているところを自動的に休日とする
* 「開いている」の定義は？
